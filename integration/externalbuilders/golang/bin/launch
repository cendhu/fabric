#!/bin/bash

# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

DIR="${BASH_SOURCE%/*}"
if [[ ! -d "$DIR" ]]; then DIR="$PWD"; fi
. "$DIR/parse.sh"

export CORE_CHAINCODE_ID_NAME="${PACKAGE_ID}"

export CORE_TLS_CLIENT_CERT_PATH="$ARTIFACTS/client.crt"
export CORE_TLS_CLIENT_KEY_PATH="$ARTIFACTS/client.key"
export CORE_PEER_TLS_ROOTCERT_FILE="$ARTIFACTS/root.crt"

# Note, for strange historical reasons, the chaincode expects the cert and key to be base64 encoded,
# but not the root cert.
jq -r .ClientCert $ARTIFACTS/chaincode.json > "$CORE_TLS_CLIENT_CERT_PATH"
jq -r .ClientKey $ARTIFACTS/chaincode.json > "$CORE_TLS_CLIENT_KEY_PATH"
jq -r .RootCert $ARTIFACTS/chaincode.json | base64 --decode > "$CORE_PEER_TLS_ROOTCERT_FILE"

if [ -z "$(cat $CORE_TLS_CLIENT_CERT_PATH)" ]  ; then
    export CORE_PEER_TLS_ENABLED=false
else 
    export CORE_PEER_TLS_ENABLED=true
fi

"$OUTPUT/chaincode" -peer.address=$(jq -r .PeerAddress "$ARTIFACTS/chaincode.json") &

PID=$?

sleep 5

disown

kill -0 $PID
exit $?

